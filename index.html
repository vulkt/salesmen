<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>متتبع متاجر المندوبين</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    /* RTL adjustments for Tailwind */
    [dir="rtl"] .text-left { text-align: right; }
    [dir="rtl"] .text-right { text-align: left; }
    [dir="rtl"] .mr-2 { margin-right: 0; margin-left: 0.5rem; }
    [dir="rtl"] .mr-3 { margin-right: 0; margin-left: 0.75rem; }
    [dir="rtl"] .ml-2 { margin-left: 0; margin-right: 0.5rem; }
    [dir="rtl"] .pl-10 { padding-left: 0.75rem; padding-right: 2.5rem; }
    [dir="rtl"] .left-3 { left: auto; right: 0.75rem; }
    [dir="rtl"] .right-4 { right: auto; left: 1rem; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen pb-20">
    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
      <div class="flex items-center justify-center">
        <h1 class="text-xl font-bold">متتبع متاجر المندوبين</h1>
      </div>
    </header>

    <div class="container mx-auto px-4 py-4 max-w-md">
      <!-- Search Bar -->
      <div class="mb-4">
        <div class="relative">
          <input
            id="searchInput"
            type="text"
            placeholder="البحث عن المتاجر أو الأماكن..."
            class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
          <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2"></i>
        </div>
        <!-- Search Results Dropdown -->
        <div id="searchResults" class="absolute z-10 w-full max-w-md bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto" style="display: none;">
          <!-- Results will be added here -->
        </div>
      </div>

      <!-- Map Section -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">مواقع المتاجر</h2>
        <div class="relative">
          <!-- Loading State -->
          <div id="loading" class="w-full h-96 bg-gray-100 rounded-xl flex items-center justify-center">
            <div class="text-center">
              <i data-lucide="loader" class="w-8 h-8 animate-spin text-indigo-600 mx-auto mb-2"></i>
              <p class="text-gray-600">جاري تحميل الخريطة...</p>
            </div>
          </div>
          
          <!-- Map Container -->
          <div id="map" class="w-full h-96 rounded-xl overflow-hidden border border-gray-200" style="display: none;"></div>
          
          <!-- Recenter Button -->
          <button 
            id="recenterBtn"
            class="absolute bottom-4 left-4 w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50"
            title="العودة إلى موقعي"
            style="display: none;"
          >
            <i data-lucide="navigation" class="w-6 h-6 text-indigo-600"></i>
          </button>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3 mb-6">
        <button 
          id="registerBtn"
          class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center"
        >
          <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
          تسجيل متجر جديد
        </button>
        <button 
          id="myStoresBtn"
          class="flex-1 bg-white border border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium flex items-center justify-center"
        >
          <i data-lucide="filter" class="w-5 h-5 ml-2"></i>
          متاجري
        </button>
      </div>

      <!-- Selected Store Info -->
      <div id="selectedStoreInfo" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-200" style="display: none;">
        <div class="flex items-start">
          <div class="bg-red-100 p-2 rounded-lg ml-3">
            <i data-lucide="map-pin" class="w-6 h-6 text-red-600"></i>
          </div>
          <div>
            <h3 id="selectedStoreName" class="font-bold text-gray-800"></h3>
            <p class="text-sm text-gray-600 mt-1">
              مسجل بواسطة: <span id="selectedStoreSalesman" class="font-medium"></span>
            </p>
            <div class="flex items-center mt-2 text-red-600">
              <i data-lucide="check-circle" class="w-4 h-4 ml-1"></i>
              <span class="text-sm">مسجل بالفعل</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div id="successMessage" class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6" style="display: none;">
        <div class="flex items-center text-green-700">
          <i data-lucide="check-circle" class="w-5 h-5 ml-2"></i>
          <span class="font-medium">تم تسجيل المتجر بنجاح!</span>
        </div>
      </div>

      <!-- Filter Active Message -->
      <div id="filterMessage" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 flex items-center justify-between" style="display: none;">
        <div class="flex items-center text-blue-700">
          <i data-lucide="filter" class="w-5 h-5 ml-2"></i>
          <span class="font-medium">عرض متاجر: <span id="filteredSalesmanName"></span></span>
        </div>
        <button id="clearFilterBtn" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
          عرض الكل
        </button>
      </div>

      <!-- My Stores Modal -->
      <div id="myStoresModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
          <h3 class="text-xl font-bold text-gray-800 mb-4">أدخل اسمك</h3>
          <p class="text-gray-600 text-sm mb-4">أدخل اسمك لعرض المتاجر التي سجلتها</p>
          <input
            id="filterNameInput"
            type="text"
            placeholder="أدخل اسمك"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4"
          />
          <div class="flex gap-3">
            <button
              id="cancelFilterBtn"
              class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-lg font-medium"
            >
              إلغاء
            </button>
            <button
              id="applyFilterBtn"
              class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-medium"
            >
              تطبيق
            </button>
          </div>
        </div>
      </div>

      <!-- Store Registration Form -->
      <div id="registerForm" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-200" style="display: none;">
        <h3 class="font-bold text-gray-800 mb-4">تسجيل متجر جديد</h3>
        <div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              اسم المتجر <span class="text-red-600">*</span>
            </label>
            <input
              id="storeName"
              type="text"
              placeholder="أدخل اسم المتجر"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              اسمك <span class="text-red-600">*</span>
            </label>
            <input
              id="salesmanName"
              type="text"
              placeholder="أدخل اسمك"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              رقم الهاتف <span class="text-gray-500 text-xs">(اختياري)</span>
            </label>
            <input
              id="storePhone"
              type="tel"
              placeholder="أدخل رقم الهاتف"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              البريد الإلكتروني <span class="text-gray-500 text-xs">(اختياري)</span>
            </label>
            <input
              id="storeEmail"
              type="email"
              placeholder="أدخل البريد الإلكتروني"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              صورة موقع الترن تيبل <span class="text-red-600">*</span>
              <span class="text-gray-500 text-xs block mt-1">قم برفع صورة لموقع الترن تيبل المحتمل</span>
            </label>
            <div class="relative">
              <input
                id="image1"
                type="file"
                accept="image/*"
                capture="environment"
                class="hidden"
              />
              <div id="image1Preview" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-indigo-500 transition-colors" onclick="document.getElementById('image1').click()">
                <i data-lucide="camera" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                <p class="text-sm text-gray-600">اضغط لالتقاط صورة أو رفعها</p>
              </div>
            </div>
          </div>
          <div id="errorMessage" class="flex items-center text-red-600 text-sm mb-3" style="display: none;">
            <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
            <span id="errorText"></span>
          </div>
          <div class="flex gap-3">
            <button
              id="cancelBtn"
              class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-lg font-medium"
            >
              إلغاء
            </button>
            <button
              id="submitBtn"
              class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center"
            >
              تسجيل المتجر
            </button>
          </div>
        </div>
      </div>

      <!-- Registered Stores List -->
      <div>
        <h2 class="text-lg font-semibold mb-3 text-gray-800">المتاجر المسجلة</h2>
        <div id="storesList" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200">
          <!-- Stores will be added here dynamically -->
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 flex justify-around">
      <button class="flex flex-col items-center text-indigo-600">
        <i data-lucide="map-pin" class="w-6 h-6 mb-1"></i>
        <span class="text-xs">الخريطة</span>
      </button>
    </nav>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBkPv3EPPwDqSiVlATiA003RGXUHxjsi30",
      authDomain: "sales-men.firebaseapp.com",
      projectId: "sales-men",
      storageBucket: "sales-men.firebasestorage.app",
      messagingSenderId: "350922579548",
      appId: "1:350922579548:web:f372a9c077eee58a211099",
      measurementId: "G-E5Z2N7KPX3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Initialize Lucide icons
    lucide.createIcons();

    // Global variables
    let map;
    let currentLocation = null;
    let selectedStore = null;
    let markers = [];
    let currentLocationMarker = null;
    let clickedLocation = null;
    let autocompleteService;
    let placesService;
    let stores = [];
    let filteredSalesman = null;
    let tempMarker = null;
    let tempInfoWindow = null;
    let uploadedImage = null;

    // Load Google Maps
    function loadGoogleMaps() {
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBdejM6PrUO8YV0mceVxnW62E8-y1Ud4xk&libraries=places&language=ar&region=SA';
      script.async = true;
      script.defer = true;
      script.onload = initApp;
      script.onerror = () => {
        alert('فشل تحميل خرائط جوجل. يرجى التحقق من مفتاح API.');
      };
      document.head.appendChild(script);
    }

    // Get current location
    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            initMap();
          },
          (error) => {
            console.error('خطأ في الحصول على الموقع:', error);
            // Fallback to Riyadh, Saudi Arabia
            currentLocation = { lat: 24.7136, lng: 46.6753 };
            initMap();
          }
        );
      } else {
        currentLocation = { lat: 24.7136, lng: 46.6753 };
        initMap();
      }
    }

    // Load stores from Firestore
    function loadStoresFromFirestore() {
      db.collection('stores').onSnapshot((snapshot) => {
        stores = [];
        snapshot.forEach((doc) => {
          stores.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        if (map) {
          updateStoreMarkers();
          renderStoresList();
        }
      }, (error) => {
        console.error('خطأ في تحميل المتاجر:', error);
      });
    }

    // Initialize map
    function initMap() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('map').style.display = 'block';
      document.getElementById('recenterBtn').style.display = 'flex';

      map = new google.maps.Map(document.getElementById('map'), {
        center: currentLocation,
        zoom: 13,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });

      // Initialize Places services
      autocompleteService = new google.maps.places.AutocompleteService();
      placesService = new google.maps.places.PlacesService(map);

      // Add current location marker
      currentLocationMarker = new google.maps.Marker({
        position: currentLocation,
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: '#4F46E5',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 3,
        },
        title: 'موقعك'
      });

      // Add store markers
      updateStoreMarkers();

      // Add click listener to map
      map.addListener('click', (event) => {
        clickedLocation = {
          lat: event.latLng.lat(),
          lng: event.latLng.lng()
        };
        
        // Show registration option for clicked location
        showRegistrationOption(clickedLocation);
      });

      // Load stores from Firestore
      loadStoresFromFirestore();
      
      // Render stores list
      renderStoresList();
      
      // Initialize search functionality
      initSearch();
      
      // Initialize image upload handler
      initImageUpload();
    }

    // Initialize image upload handler
    function initImageUpload() {
      const input = document.getElementById('image1');
      const preview = document.getElementById('image1Preview');
      
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('يجب أن يكون حجم الصورة أقل من 5 ميجابايت');
            input.value = '';
            return;
          }
          
          // Read and display preview
          const reader = new FileReader();
          reader.onload = (event) => {
            uploadedImage = event.target.result;
            
            // Update preview
            preview.innerHTML = `
              <div class="relative">
                <img src="${event.target.result}" class="w-full h-48 object-cover rounded-lg" alt="معاينة">
                <div class="absolute top-2 left-2 bg-green-500 text-white rounded-full p-1">
                  <i data-lucide="check" class="w-4 h-4"></i>
                </div>
                <button onclick="removeImage(); event.stopPropagation();" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                  <i data-lucide="x" class="w-4 h-4"></i>
                </button>
                <p class="text-xs text-gray-600 mt-2 text-center">اضغط للتغيير</p>
              </div>
            `;
            lucide.createIcons();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Remove uploaded image
    function removeImage() {
      uploadedImage = null;
      document.getElementById('image1').value = '';
      document.getElementById('image1Preview').innerHTML = `
        <i data-lucide="camera" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
        <p class="text-sm text-gray-600">اضغط لالتقاط صورة أو رفعها</p>
      `;
      lucide.createIcons();
    }

    // Update store markers
    function updateStoreMarkers() {
      // Clear existing markers
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // Filter stores if needed
      const displayStores = filteredSalesman 
        ? stores.filter(s => s.salesman.toLowerCase() === filteredSalesman.toLowerCase())
        : stores;

      // Add new markers
      displayStores.forEach(store => {
        const marker = new google.maps.Marker({
          position: { lat: store.lat, lng: store.lng },
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: store.visited ? '#EF4444' : '#10B981',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
          },
          title: store.name
        });

        // Add info window
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 8px; direction: rtl; text-align: right;">
              <h3 style="font-weight: bold; margin-bottom: 4px;">${store.name}</h3>
              <p style="font-size: 14px; color: #666;">مسجل بواسطة: ${store.salesman}</p>
              <p style="font-size: 12px; color: ${store.visited ? '#EF4444' : '#10B981'}; margin-top: 4px;">
                ${store.visited ? '✓ مسجل بالفعل' : '○ غير مسجل'}
              </p>
            </div>
          `
        });

        marker.addListener('click', () => {
          selectStore(store);
          infoWindow.open(map, marker);
          map.panTo({ lat: store.lat, lng: store.lng });
        });

        // Highlight selected store
        if (selectedStore && selectedStore.id === store.id) {
          marker.setIcon({
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: store.visited ? '#EF4444' : '#10B981',
            fillOpacity: 1,
            strokeColor: '#FCD34D',
            strokeWeight: 3,
          });
          infoWindow.open(map, marker);
        }

        markers.push(marker);
      });
    }

    // Select store
    function selectStore(store) {
      selectedStore = store;
      document.getElementById('selectedStoreInfo').style.display = 'block';
      document.getElementById('selectedStoreName').textContent = store.name;
      document.getElementById('selectedStoreSalesman').textContent = store.salesman;
      document.getElementById('registerForm').style.display = 'none';
      updateStoreMarkers();
      lucide.createIcons();
    }

    // Show registration option for clicked map location
    function showRegistrationOption(location) {
      // Remove previous temp marker if exists
      if (tempMarker) {
        tempMarker.setMap(null);
      }
      if (tempInfoWindow) {
        tempInfoWindow.close();
      }

      // Create temporary marker at clicked location
      tempMarker = new google.maps.Marker({
        position: location,
        map: map,
        animation: google.maps.Animation.DROP,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: '#6366F1',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 3,
        }
      });

      // Try to get place details using reverse geocoding
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: location }, (results, status) => {
        let placeName = 'الموقع المحدد';
        let placeAddress = '';
        
        if (status === 'OK' && results[0]) {
          placeName = results[0].name || results[0].formatted_address.split(',')[0];
          placeAddress = results[0].formatted_address;
        }

        // Show info window with registration option
        tempInfoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 8px; min-width: 200px; direction: rtl; text-align: right;">
              <h3 style="font-weight: bold; margin-bottom: 4px;">${placeName}</h3>
              ${placeAddress ? `<p style="font-size: 12px; color: #666; margin-bottom: 8px;">${placeAddress}</p>` : ''}
              <button id="registerLocationBtn" style="background: #4F46E5; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; width: 100%;">
                تسجيل هذا المتجر
              </button>
            </div>
          `
        });

        tempInfoWindow.open(map, tempMarker);

        // Handle register button click
        google.maps.event.addListener(tempInfoWindow, 'domready', () => {
          const registerBtn = document.getElementById('registerLocationBtn');
          if (registerBtn) {
            registerBtn.onclick = () => {
              clickedLocation = location;
              document.getElementById('storeName').value = placeName !== 'الموقع المحدد' ? placeName : '';
              document.getElementById('registerForm').style.display = 'block';
              document.getElementById('selectedStoreInfo').style.display = 'none';
              document.getElementById('errorMessage').style.display = 'none';
              tempInfoWindow.close();
              if (tempMarker) {
                tempMarker.setMap(null);
              }
              
              // Scroll to form
              document.getElementById('registerForm').scrollIntoView({ behavior: 'smooth' });
            };
          }
        });
      });
    }

    // Render stores list
    function renderStoresList() {
      const storesList = document.getElementById('storesList');
      storesList.innerHTML = '';

      // Filter stores if needed
      const displayStores = filteredSalesman 
        ? stores.filter(s => s.salesman.toLowerCase() === filteredSalesman.toLowerCase())
        : stores;

      if (displayStores.length === 0) {
        storesList.innerHTML = '<div class="p-4 text-center text-gray-500">لا توجد متاجر</div>';
        return;
      }

      displayStores.forEach(store => {
        const storeDiv = document.createElement('div');
        storeDiv.className = `p-4 border-b border-gray-100 last:border-b-0 cursor-pointer hover:bg-gray-50 ${
          selectedStore?.id === store.id ? 'bg-indigo-50' : ''
        }`;
        storeDiv.onclick = () => {
          selectStore(store);
          map.panTo({ lat: store.lat, lng: store.lng });
        };

        storeDiv.innerHTML = `
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full ml-3 ${store.visited ? 'bg-red-500' : 'bg-green-500'}"></div>
            <div class="flex-1">
              <h3 class="font-medium text-gray-800">${store.name}</h3>
              <p class="text-sm text-gray-600">مسجل بواسطة: ${store.salesman}</p>
            </div>
            <i data-lucide="map-pin" class="w-5 h-5 text-gray-400"></i>
          </div>
        `;

        storesList.appendChild(storeDiv);
      });

      lucide.createIcons();
    }

    // Initialize search functionality
    function initSearch() {
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');
      let searchTimeout;

      // Search input handler
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }

        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      });

      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
    }

    // Perform search
    function performSearch(query) {
      const searchResults = document.getElementById('searchResults');
      searchResults.innerHTML = '';
      
      // Search registered stores
      const matchingStores = stores.filter(store => 
        store.name.toLowerCase().includes(query) ||
        store.salesman.toLowerCase().includes(query)
      );

      // Display registered stores
      if (matchingStores.length > 0) {
        const storesHeader = document.createElement('div');
        storesHeader.className = 'px-4 py-2 bg-gray-50 font-semibold text-sm text-gray-700 border-b';
        storesHeader.textContent = 'المتاجر المسجلة';
        searchResults.appendChild(storesHeader);

        matchingStores.forEach(store => {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b';
          resultDiv.innerHTML = `
            <div class="flex items-center">
              <div class="w-2 h-2 rounded-full ml-3 ${store.visited ? 'bg-red-500' : 'bg-green-500'}"></div>
              <div class="flex-1">
                <div class="font-medium text-gray-800">${store.name}</div>
                <div class="text-sm text-gray-600">بواسطة: ${store.salesman}</div>
              </div>
              <i data-lucide="map-pin" class="w-4 h-4 text-gray-400"></i>
            </div>
          `;
          resultDiv.onclick = () => {
            selectStore(store);
            map.panTo({ lat: store.lat, lng: store.lng });
            map.setZoom(16);
            searchResults.style.display = 'none';
            document.getElementById('searchInput').value = store.name;
          };
          searchResults.appendChild(resultDiv);
        });
      }

      // Search Google Places
      if (autocompleteService) {
        autocompleteService.getPlacePredictions(
          {
            input: query,
            location: new google.maps.LatLng(currentLocation.lat, currentLocation.lng),
            radius: 50000,
            language: 'ar',
            componentRestrictions: { country: 'sa' }
          },
          (predictions, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
              // Add header for Google Places
              if (matchingStores.length > 0) {
                const divider = document.createElement('div');
                divider.className = 'px-4 py-2 bg-gray-50 font-semibold text-sm text-gray-700 border-b';
                divider.textContent = 'الأماكن القريبة';
                searchResults.appendChild(divider);
              }

              predictions.slice(0, 5).forEach(prediction => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b';
                resultDiv.innerHTML = `
                  <div class="flex items-start">
                    <i data-lucide="map-pin" class="w-4 h-4 text-indigo-600 ml-3 mt-1 flex-shrink-0"></i>
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-gray-800 truncate">${prediction.structured_formatting.main_text}</div>
                      <div class="text-sm text-gray-600 truncate">${prediction.structured_formatting.secondary_text || ''}</div>
                    </div>
                  </div>
                `;
                resultDiv.onclick = () => {
                  selectPlaceById(prediction.place_id, prediction.structured_formatting.main_text);
                };
                searchResults.appendChild(resultDiv);
              });

              lucide.createIcons();
            }
          }
        );
      }

      if (matchingStores.length === 0 && searchResults.children.length === 0) {
        searchResults.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">لا توجد نتائج</div>';
      }

      searchResults.style.display = 'block';
      lucide.createIcons();
    }

    // Select place by ID
    function selectPlaceById(placeId, placeName) {
      const request = {
        placeId: placeId,
        fields: ['geometry', 'name', 'formatted_address']
      };

      placesService.getDetails(request, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place.geometry) {
          const location = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
          
          map.panTo(location);
          map.setZoom(16);
          
          // Remove previous temp marker if exists
          if (tempMarker) {
            tempMarker.setMap(null);
          }
          if (tempInfoWindow) {
            tempInfoWindow.close();
          }
          
          // Add temporary marker
          tempMarker = new google.maps.Marker({
            position: location,
            map: map,
            animation: google.maps.Animation.DROP,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: '#6366F1',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 3,
            }
          });

          // Show info window
          tempInfoWindow = new google.maps.InfoWindow({
            content: `
              <div style="padding: 8px; direction: rtl; text-align: right;">
                <h3 style="font-weight: bold; margin-bottom: 4px;">${place.name}</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 8px;">${place.formatted_address || ''}</p>
                <button id="registerHereBtn" style="background: #4F46E5; color: white; padding: 6px 12px; border-radius: 6px; font-size: 14px; border: none; cursor: pointer;">
                  تسجيل هذا المتجر
                </button>
              </div>
            `
          });

          tempInfoWindow.open(map, tempMarker);

          // Handle register button click
          google.maps.event.addListener(tempInfoWindow, 'domready', () => {
            document.getElementById('registerHereBtn').onclick = () => {
              clickedLocation = location;
              document.getElementById('storeName').value = place.name;
              document.getElementById('registerForm').style.display = 'block';
              document.getElementById('selectedStoreInfo').style.display = 'none';
              document.getElementById('errorMessage').style.display = 'none';
              tempInfoWindow.close();
              tempMarker.setMap(null);
              
              // Scroll to form
              document.getElementById('registerForm').scrollIntoView({ behavior: 'smooth' });
            };
          });

          document.getElementById('searchResults').style.display = 'none';
          document.getElementById('searchInput').value = placeName;
        }
      });
    }

    // Recenter map
    document.getElementById('recenterBtn').onclick = () => {
      if (map && currentLocation) {
        map.panTo(currentLocation);
        map.setZoom(15);
      }
    };

    // Show register form
    document.getElementById('registerBtn').onclick = () => {
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('selectedStoreInfo').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('storeName').value = '';
      document.getElementById('salesmanName').value = '';
      document.getElementById('storePhone').value = '';
      document.getElementById('storeEmail').value = '';
      
      // Reset image
      removeImage();
      
      clickedLocation = null;
    };

    // Cancel registration
    document.getElementById('cancelBtn').onclick = () => {
      document.getElementById('registerForm').style.display = 'none';
      clickedLocation = null;
      
      // Remove temp marker if exists
      if (tempMarker) {
        tempMarker.setMap(null);
        tempMarker = null;
      }
      if (tempInfoWindow) {
        tempInfoWindow.close();
        tempInfoWindow = null;
      }
    };

    // Submit new store
    document.getElementById('submitBtn').onclick = async () => {
      const storeName = document.getElementById('storeName').value.trim();
      const salesmanName = document.getElementById('salesmanName').value.trim();
      const storePhone = document.getElementById('storePhone').value.trim();
      const storeEmail = document.getElementById('storeEmail').value.trim();

      // Validate required fields
      if (!storeName || !salesmanName) {
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('errorText').textContent = 'يرجى ملء جميع الحقول المطلوبة';
        lucide.createIcons();
        return;
      }

      // Validate image
      if (!uploadedImage) {
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('errorText').textContent = 'يرجى رفع صورة موقع الترن تيبل';
        lucide.createIcons();
        return;
      }

      // Validate email format if provided
      if (storeEmail && !validateEmail(storeEmail)) {
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('errorText').textContent = 'يرجى إدخال عنوان بريد إلكتروني صحيح';
        lucide.createIcons();
        return;
      }

      // Show loading state
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 ml-2 animate-spin"></i>جاري التسجيل...';
      lucide.createIcons();

      // Use clicked location or current location
      const storeLocation = clickedLocation || currentLocation;
      
      const newStore = {
        name: storeName,
        lat: storeLocation.lat,
        lng: storeLocation.lng,
        salesman: salesmanName,
        phone: storePhone || null,
        email: storeEmail || null,
        image: uploadedImage,
        visited: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Save to Firestore
      try {
        const docRef = await db.collection('stores').add(newStore);
        console.log('تم تسجيل المتجر بمعرف:', docRef.id);
        
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('storeName').value = '';
        document.getElementById('salesmanName').value = '';
        document.getElementById('storePhone').value = '';
        document.getElementById('storeEmail').value = '';
        
        // Reset image
        removeImage();
        
        clickedLocation = null;
        
        if (map) {
          map.panTo({ lat: newStore.lat, lng: newStore.lng });
        }

        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'تسجيل المتجر';
        lucide.createIcons();

        // Hide success message after 3 seconds
        setTimeout(() => {
          document.getElementById('successMessage').style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error('خطأ في إضافة المتجر:', error);
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('errorText').textContent = 'خطأ في تسجيل المتجر. يرجى المحاولة مرة أخرى.';
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'تسجيل المتجر';
        lucide.createIcons();
      }
    };

    // Validate email format
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // My Stores button handler
    document.getElementById('myStoresBtn').onclick = () => {
      document.getElementById('myStoresModal').style.display = 'flex';
      document.getElementById('filterNameInput').value = '';
      document.getElementById('filterNameInput').focus();
    };

    // Cancel filter
    document.getElementById('cancelFilterBtn').onclick = () => {
      document.getElementById('myStoresModal').style.display = 'none';
    };

    // Apply filter
    document.getElementById('applyFilterBtn').onclick = () => {
      const name = document.getElementById('filterNameInput').value.trim();
      
      if (!name) {
        alert('يرجى إدخال اسمك');
        return;
      }

      // Check if any stores exist for this salesman
      const myStores = stores.filter(s => s.salesman.toLowerCase() === name.toLowerCase());
      
      if (myStores.length === 0) {
        alert(`لم يتم العثور على متاجر مسجلة باسم "${name}". يرجى التحقق من تهجئة الاسم.`);
        return;
      }

      filteredSalesman = name;
      document.getElementById('myStoresModal').style.display = 'none';
      document.getElementById('filterMessage').style.display = 'flex';
      document.getElementById('filteredSalesmanName').textContent = name;
      document.getElementById('selectedStoreInfo').style.display = 'none';
      document.getElementById('registerForm').style.display = 'none';
      
      updateStoreMarkers();
      renderStoresList();
      lucide.createIcons();

      // Zoom to fit filtered stores
      if (map) {
        const bounds = new google.maps.LatLngBounds();
        myStores.forEach(store => {
          bounds.extend({ lat: store.lat, lng: store.lng });
        });
        map.fitBounds(bounds);
        
        // Add some padding to the bounds
        if (myStores.length === 1) {
          map.setZoom(15);
        }
      }
    };

    // Clear filter
    document.getElementById('clearFilterBtn').onclick = () => {
      filteredSalesman = null;
      document.getElementById('filterMessage').style.display = 'none';
      selectedStore = null;
      document.getElementById('selectedStoreInfo').style.display = 'none';
      
      updateStoreMarkers();
      renderStoresList();
      
      if (map && currentLocation) {
        map.panTo(currentLocation);
        map.setZoom(13);
      }
    };

    // Close modal on Enter key
    document.getElementById('filterNameInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('applyFilterBtn').click();
      }
    });

    // Initialize app
    function initApp() {
      getCurrentLocation();
    }

    // Load Google Maps on page load
    loadGoogleMaps();
  </script>
</body>
</html>
